@model IEnumerable<Gestion_Usuarios.Models.StudentViewModel>
@{
    ViewData["Title"] = "Gestión de Alumnos";
}

<div class="card shadow-sm">
    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
        <h5 class="m-0 font-weight-bold text-primary"><i class="fa-solid fa-user-graduate me-2"></i>Listado de Alumnos</h5>
        <button class="btn btn-success btn-sm"><i class="fa-solid fa-plus me-1"></i> Nuevo Alumno</button>
    </div>
    <div class="card-body">
        <table id="miTabla" class="table table-striped table-hover dt-responsive nowrap" style="width:100%">
            <thead>
                <tr>
                    <th>Matrícula / Folio</th>
                    <th>Nombre Completo</th>
                    <th>Carrera</th>
                    <th>Semestre</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @if (Model != null)
                {
                    foreach (var item in Model)
                    {
                        <tr data-id="@item.Id">
                            <td>@item.Identificador</td>

                            <td>@item.NombreCompleto</td>

                            <td>@item.Carrera</td>

                            <td>
                                @if (item.Semestre.HasValue)
                                {
                                    <span class="badge bg-info">@item.Semestre ° Sem</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">N/A</span>
                                }
                            </td>

                            <td>
                                <span class="badge @item.EstadoBadgeClass">
                                    @item.EstadoCodigo
                                </span>
                            </td>

                            <td>
                                <button class="btn btn-primary btn-sm" onclick="editarAlumno(@item.Id)">
                                    <i class="fa-solid fa-pen-to-square"></i>
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="eliminarAlumno(@item.Id)">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script src="~/js/datatables_tools.js"></script>
    <script>
        $(document).ready(function () {
            // Inicializar DataTable
            const options = {
                searchBuilder: true,
                colVis: true,
                colReorder: true
            };

            const dt = new DataTableInitializer(options);

            window.alumnosTable = dt.initialize('#miTabla', {
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/2.0.0/i18n/es-ES.json'
                }
            });
        });

        function editarAlumno(id) {
            // Redirigir a la ruta de edición del alumno
            if (!id || id <= 0) return;
            window.location.href = `/Alumnos/Edit/${id}`;
        }

        function eliminarAlumno(id) {
            // Confirmación y llamada al endpoint de eliminación
            if (!confirm('¿Deseas eliminar el alumno seleccionado?')) return;

            fetch(`/Alumnos/Delete/${id}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            }).then(r => {
                if (r.ok) {
                    // Soft-delete: actualizar la fila en la UI sin recargar
                    const $row = $(`#miTabla tbody tr[data-id='${id}']`);

                    if ($row.length) {
                        // Actualizar badge de estado (columna 5, índice 4)
                        const $estadoCell = $row.find('td').eq(4);
                        $estadoCell.find('span').removeClass().addClass('badge bg-danger').text('BAJA');

                        // Deshabilitar los botones de acción en la fila
                        $row.find('button').prop('disabled', true).addClass('disabled');

                        // Si existe instancia de DataTable, invalidar y redibujar la fila
                        if (window.alumnosTable) {
                            window.alumnosTable.row($row).invalidate().draw(false);
                        }
                    } else {
                        // Fallback: recargar si no se encuentra la fila
                        window.location.reload();
                    }
                } else {
                    r.json().then(j => alert(j?.message || 'Error al eliminar'));
                }
            }).catch(err => alert(err.message || 'Error al eliminar'));
        }
    </script>
}